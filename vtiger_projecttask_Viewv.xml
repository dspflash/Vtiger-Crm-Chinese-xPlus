<GroupBox Name="GBDVvtiger_projecttask" cols="xs12 sm12 md12 lg12"><Ctrls>
<ListCtrl Name="vtiger_projecttask_vLst" ToolTip="ttp_vtiger_projecttask" Size="700,420" loadedclick="0" onload="init" colsDisplay="10" filtering="3,新任务,新任务,1,#ff0000;3,进行中,进行中,1,#00ff00;8,1,1,1,#ff0000,●">
	<DbDetails >
<DbTable>vtigercrm6.vtiger_projecttask v left join vtigercrm6.vtiger_projecttasktype v0 on v.projecttasktype=v0.projecttasktypeid left join vtigercrm6.users_v v1 on v.responsible=v1.id left join vtigercrm6.vtiger_projecttaskpriority v2 on v.projecttaskpriority=v2.projecttaskpriorityid left join vtigercrm6.vtiger_projecttaskstatus v3 on v.projecttaskstatus=v3.projecttaskstatusid left join vtigercrm6.vtiger_users v4 on v.created_by=v4.id left join vtigercrm6.vtiger_users v5 on v.last_update_by=v5.id join vtiger_project p on p.projectid=v.projectid left join vtiger_projectstatus ps on ps.projectstatusid=p.projectstatus left join vtigercrm6.vtiger_account ac on p.linktoaccountscontacts=ac.accountid LEFT JOIN contacts_v cv ON (cv.contactid=v.linkcontact) LEFT JOIN `vtiger_projectmilestone` `vpm` ON ((`v`.`projectid` = `vpm`.`projectid`) AND (NOT(`vpm`.`reviewed`)) AND  ((ISNULL(`v`.`project_ms_idx`) and (`vpm`.`projectmilestonedate` &lt; `v`.`schedule_date`)) OR (`v`.`project_ms_idx` &gt; `vpm`.`project_ms_idx`))) LEFT JOIN `vtiger_projectmilestone` `vm` ON (((`v`.`projectid` = `vm`.`projectid`) AND ((ISNULL(`v`.`project_ms_idx`) AND (`vm`.`projectmilestonedate` >= `v`.`schedule_date`)) OR (`v`.`project_ms_idx` = `vm`.`project_ms_idx`)))) LEFT JOIN vtigercrm6.attachment a ON a.reftbl='vtiger_projecttask' AND a.refid=v.projecttaskid left join vtigercrm6.vtiger_salesorder_item soi on (p.refertbl='salesorder_item' and soi.salesorder_itemid=p.referid) </DbTable>
<Index>projecttaskid</Index>
<Data>v.projecttaskname,soi.itemcode productcode,soi.customitem,v3.projecttaskstatus projecttaskstatus,DATE_FORMAT(v.schedule_date,'%Y-%m-%d') schedule_date,vm.projectmilestonename,p.projectname,ac.accountname linktoaccountscontacts,attachedfile,GROUP_CONCAT(filename SEPARATOR ';') attachments, v.address,IF(addrlng,concat(v.addrlng,',',v.addrlat),NULL) addrloc,v.contact contact,v.telphone mobile,cv.phone,v.addrlng,v.addrlat,v.startdate,v.enddate,v.description,v0.projecttasktype projecttasktype,v1.fullname responsible,ps.projectstatus,v.projecttaskprogress,v.projecttaskhours,p.project_no,v2.projecttaskpriority projecttaskpriority,v4.user_name created_by,v.creation_date,v5.user_name last_update_by,v.last_update_date,v.projectid,v.projecttaskid,projecttaskstatusid,  MAX(`vpm`.`projectmilestonedate`) AS `projectmilestonedate`,`vpm`.`projectmilestoneid` AS `projectmilestoneid`,`vpm`.`reviewed` AS `reviewed`,v.attachedfile
</Data>
<Order>projecttaskid</Order>
<Where> and v.projecttaskstatus in (2,3)</Where>
<queryFormat>select %{data} from %{dbtable} where IF('%{responsible[id]}'='',IF(v.responsible,v.responsible,vpm.responsible)='%{user_id}',1) and p.projectstatus not in (10) %{where} GROUP BY `v`.`projecttaskid` ORDER BY schedule_date limit %{StartRow},%{PgSize}</queryFormat></DbDetails>2,9,
<operator refresh="1" firstpage="1" prepage="1" nextpage="1">
<op text="taskprogress" mustselected="1"><if cond="(!%{vtiger_projecttask_vLst[projecttaskid]})||!((%{vtiger_projecttask_vLst[projecttaskstatusid]}==3)||(%{vtiger_projecttask_vLst[projecttaskstatusid]}==2))||(%{vtiger_projecttask_vLst[projectmilestoneid]})"><alert expr="任务不可操作!"/><else/><assign name="$this.attachment.projecttaskid" expr="%{vtiger_projecttask_vLst[projecttaskid]}"/><assign name="$this.attachment.attachedfile" expr="%{vtiger_projecttask_vLst[attachedfile]}"/><assign name="$this.attachment.project_no" expr="%{vtiger_projecttask_vLst[project_no]}"/><assign name="$this.attachment.task_remark" expr="%{vtiger_projecttask_vLst[description]}"/><assign name="$this.attachment.address" expr="%{vtiger_projecttask_vLst[address]}"/><assign name="$this.attachment.address[location]" expr="%{vtiger_projecttask_vLst[addrloc]}"/><if cond="'%{vtiger_projecttask_vLst[addrloc]}'"><SetVisible name="$this.attachment.location" Visible="1"/><else/><SetVisible name="$this.attachment.location" Visible="0"/></if><assign name="$this.attachment.contact" expr="%{vtiger_projecttask_vLst[contact]}"/><assign name="$this.attachment.mobile" expr="%{vtiger_projecttask_vLst[mobile]}"/><submit next="$this.attachment.attachment_vLst"/></if></op>
<op text="attachments"><if cond="!%{vtiger_projecttask_vLst[projecttaskid]}"><alert expr="projecttaskid is Empty!"/><else/><DbDetails><Where>reftbl='vtiger_projecttask' and refid='%{vtiger_projecttask_vLst[projecttaskid]}'</Where></DbDetails><submit namelist="DbDetails" next="$this.attachment_v.attachment_vLst"/></if></op>
<op text="completetask" needconfirm="1"><DbDetails>
<DbTable>vtigercrm6.vtiger_projecttask pt join vtigercrm6.attachment a on (pt.projecttaskid=a.refid and a.reftbl='vtiger_projecttask')</DbTable>
<Where>projecttaskid='%{vtiger_projecttask_vLst[projecttaskid]}' and projecttaskstatus=3</Where>
<queryFormat>update %{table} set projecttaskstatus=4,enddate=now() where %{where}</queryFormat></DbDetails>
<submit namelist="DbDetails"/><submit/></op>
</operator>
<Editor><ed col="3" Type="ComboBox" items="新任务|进行中|取消|完成"/><ed col="1" Type="ComboBox" items="1|2|3|4"/><ed col="2" Type="TextBox"/><OnChanged><!--DbDetails><queryFormat>update vtigercrm6.vtiger_projecttask set projecttaskstatus=%{ED(3)},customitem=%{ED(2)} where projecttaskid='%{vtiger_projecttask_vLst[projecttaskid]}'</queryFormat></DbDetails><submit namelist="DbDetails"/><submit/--><EvalTbl rules="%{lsteditor}" table="lsteditor">
			<rules><xi:include xmlns:xi="http://www.w3.org/2001/XInclude" href="rule/lsteditor.xml"/></rules>
			<inputs customitem="%{ED(2)}"/>
			<outputs title="text" handler="handler"/></EvalTbl></OnChanged></Editor>
</ListCtrl>
</Ctrls></GroupBox>